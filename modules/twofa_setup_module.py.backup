"""
2FA Setup Module
Användare kan aktivera/inaktivera 2FA och scanna QR-kod
"""

import customtkinter as ctk
from typing import Callable, Optional
from PIL import Image, ImageTk
from io import BytesIO
from core.debug_logger import debug, info, warning, error
from core.ui_components import (
    CustomButton, CustomEntry, CustomLabel,
    CustomFrame, MessageBox
)
from core.twofa_system import TwoFASystem


class TwoFASetupModule(ctk.CTkFrame):
    """2FA setup module"""
    
    def __init__(
        self,
        master,
        user_id: int,
        user_email: str,
        on_complete: Callable,
        on_cancel: Callable,
        **kwargs
    ):
        """Initialize 2FA setup module"""
        debug("TwoFASetupModule", f"Initializing 2FA setup for user: {user_email}")
        
        super().__init__(master, fg_color="transparent", **kwargs)
        
        self.user_id = user_id
        self.user_email = user_email
        self.on_complete = on_complete
        self.on_cancel = on_cancel
        self.twofa = TwoFASystem()
        
        # Check current 2FA status
        self.is_enabled, self.current_secret = self.twofa.get_user_2fa_status(user_id)
        
        # Generate new secret and backup codes
        self.secret = self.twofa.generate_secret()
        self.backup_codes = self.twofa.generate_backup_codes()
        
        self._create_ui()
        
        info("TwoFASetupModule", "2FA setup module initialized")
    
    def _create_ui(self):
        """Create 2FA setup UI"""
        debug("TwoFASetupModule", "Creating 2FA setup UI")
        
        # Use full window - no container
        self.grid_rowconfigure(0, weight=1)
        self.grid_columnconfigure(0, weight=1)
        
        # Main content frame - use entire window
            bold=True
        ).pack(pady=(15, 5))
        
        CustomLabel(
            backup_frame,
            text="Save these codes in a safe place. Each can be used once if you lose access to your authenticator.",
            size=10,
            color=("#999999", "#999999")
        ).pack(pady=(0, 10), padx=20)
        
        # Display backup codes in two columns
        codes_container = CustomFrame(backup_frame, transparent=True)
        codes_container.pack(pady=(0, 15), padx=20)
        
        # Split codes into two columns
        mid = len(self.backup_codes) // 2
        
        # Left column
        left_codes = ctk.CTkTextbox(
            codes_container,
            width=380,
            height=120,
            font=("Courier New", 11)
        )
        left_codes.pack(side="left", padx=(0, 10))
        left_display = "\n".join([f"  {i+1}. {code}" for i, code in enumerate(self.backup_codes[:mid])])
        left_codes.insert("1.0", left_display)
        left_codes.configure(state="disabled")
        
        # Right column
        right_codes = ctk.CTkTextbox(
            codes_container,
            width=380,
            height=120,
            font=("Courier New", 11)
        )
        right_codes.pack(side="left")
        right_display = "\n".join([f"  {i+mid+1}. {code}" for i, code in enumerate(self.backup_codes[mid:])])
        right_codes.insert("1.0", right_display)
        right_codes.configure(state="disabled")
        
        # Action buttons
        button_frame = CustomFrame(scroll_frame, transparent=True)
        button_frame.pack(pady=15)
        
        verify_btn = CustomButton(
            button_frame,
            text="✓ Verify & Enable 2FA",
            command=self._verify_and_enable,
            width=250,
            height=45,
            style="success"
        )
        verify_btn.pack(side="left", padx=10)
        
        cancel_btn = CustomButton(
            button_frame,
            text="Cancel",
            command=self._handle_cancel,
            width=150,
            height=45,
            style="secondary"
        )
        cancel_btn.pack(side="left", padx=10)
        
        debug("TwoFASetupModule", "2FA setup UI created")
    
    def _create_step(self, parent, number: str, title: str, description: str) -> ctk.CTkFrame:
        """Create a step section"""
        step_frame = CustomFrame(parent, transparent=False)
        step_frame.pack(fill="x", pady=10, padx=20)
        
        # Header
        header_frame = CustomFrame(step_frame, transparent=True)
        header_frame.pack(fill="x", padx=20, pady=(15, 10))
        
        # Step number circle
        number_label = ctk.CTkLabel(
            header_frame,
            text=number,
            font=("Segoe UI", 16, "bold"),
            width=35,
            height=35,
            fg_color=("#1f6aa5", "#144870"),
            corner_radius=17
        )
        number_label.pack(side="left", padx=(0, 15))
        
        # Title
        title_label = CustomLabel(
            header_frame,
            text=title,
            size=14,
            bold=True
        )
        title_label.pack(side="left", anchor="w")
        
        # Description
        desc_label = CustomLabel(
            step_frame,
            text=description,
            size=11,
            color=("#cccccc", "#cccccc")
        )
        desc_label.pack(anchor="w", padx=(75, 20), pady=(0, 15))
        
        return step_frame
    
    def _verify_and_enable(self):
        """Verify code and enable 2FA"""
        debug("TwoFASetupModule", "Verify and enable 2FA")
        
        code = self.code_entry.get_value().strip()
        
        if not code:
            warning("TwoFASetupModule", "Code is empty")
            MessageBox.show_error(
                self.master,
                "Verification Error",
                "Please enter the 6-digit code from your authenticator app."
            )
            return
        
        if len(code) != 6 or not code.isdigit():
            warning("TwoFASetupModule", "Invalid code format")
            MessageBox.show_error(
                self.master,
                "Verification Error",
                "Please enter a valid 6-digit code."
            )
            return
        
        # Verify token
        debug("TwoFASetupModule", "Verifying TOTP token")
        if self.twofa.verify_token(self.secret, code):
            info("TwoFASetupModule", "Token verified successfully")
            
            # Enable 2FA for user
            if self.twofa.enable_2fa_for_user(self.user_id, self.secret, self.backup_codes):
                info("TwoFASetupModule", f"2FA enabled for user: {self.user_email}")
                
                MessageBox.show_success(
                    self.master,
                    "2FA Enabled!",
                    "Two-Factor Authentication has been enabled successfully.\n\nMake sure to save your backup codes!"
                )
                
                # Complete setup
                self.after(100, self.on_complete)
            else:
                error("TwoFASetupModule", "Failed to enable 2FA")
                MessageBox.show_error(
                    self.master,
                    "Setup Error",
                    "Failed to enable 2FA. Please try again."
                )
        else:
            warning("TwoFASetupModule", "Token verification failed")
            MessageBox.show_error(
                self.master,
                "Verification Failed",
                "Invalid code. Please check your authenticator app and try again."
            )
    
    def _handle_cancel(self):
        """Handle cancel button"""
        debug("TwoFASetupModule", "Cancel button clicked")
        self.on_cancel()


if __name__ == "__main__":
    # Test 2FA setup module
    info("TEST", "Testing TwoFASetupModule...")
    
    from core.custom_window import CustomWindow
    
    def on_complete():
        print("2FA setup completed")
    
    def on_cancel():
        print("2FA setup cancelled")
    
    app = CustomWindow(title="2FA Setup Test", width=650, height=750)
    
    setup_module = TwoFASetupModule(
        app.content_frame,
        user_id=1,
        user_email="test@example.com",
        on_complete=on_complete,
        on_cancel=on_cancel
    )
    setup_module.pack(fill="both", expand=True)
    
    info("TEST", "Starting mainloop...")
    app.mainloop()
